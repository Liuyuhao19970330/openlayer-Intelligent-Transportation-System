<!DOCTYPE html>
<html lang="">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <link rel="icon" href="<%= BASE_URL %>favicon.ico">
    <title><%= htmlWebpackPlugin.options.title %></title>

    <script src="<%= BASE_URL %>static/OL_SDK/include-openlayers-local.js"></script>
    <script src="<%= BASE_URL %>static/OL_SDK/cdn/ol/ol.js"></script>
    <script src="<%= BASE_URL %>static/OL_SDK/cdn/ol/ol.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <link rel="stylesheet" href="https://lib.baomitu.com/ol3/3.21.0-beta.2/ol.css">
  <link rel="stylesheet" href="https://at.alicdn.com/t/c/font_4227498_1i3117olwd9.css?spm=a313x.manage_type_myprojects.i1.9.2dea3a81i3QE5i&file=font_4227498_1i3117olwd9.css">
  <script src="https://lib.baomitu.com/ol3/3.21.0-beta.2/ol.js"></script>
  </head>
  <body>
    <noscript>
      <strong>We're sorry but <%= htmlWebpackPlugin.options.title %> doesn't work properly without JavaScript enabled. Please enable it to continue.</strong>
    </noscript>
    <div id="app"></div>
    <script>
      const docLayer = new Zondy.Map.Doc('','guanggu',{
            host:'localhost',
            port:6163
        })

        function querySuccess(result){
            console.log(result)
        }
        // 车流量的feature↓↓
         function queryByLayer() {
            //初始化查询结构对象，设置查询结构包含几何信息
            var queryStruct = new Zondy.Service.QueryFeatureStruct();
            //是否包含几何图形信息
            queryStruct.IncludeGeometry = true;
            //是否包含属性信息
            queryStruct.IncludeAttribute = true;
            //是否包含图形显示参数
            queryStruct.IncludeWebGraphic = false;
            //指定查询规则
            var rule = new Zondy.Service.QueryFeatureRule({
                //是否将要素的可见性计算在内
                EnableDisplayCondition: false,
                //是否完全包含
                MustInside: false,
                //是否仅比较要素的外包矩形
                CompareRectOnly: false,
                //是否相交
                Intersect: true
            });
            //实例化查询参数对象
            var queryParam = new Zondy.Service.QueryParameter({
                resultFormat: "json",
                struct: queryStruct,
                rule: rule
            });
            //设置查询分页号
            queryParam.pageIndex = 0;
            //设置查询要素数目
            queryParam.recordNumber = 50;
            var queryService = new Zondy.Service.QueryDocFeature(queryParam,
                "guanggu",
                1, {

            });

            //执行查询操作，querySuccess为查询回调函数
           queryService.query(querySuccess);
        }
        
        function querySuccess(result) {
            var format = new Zondy.Format.PolygonJSON();//反序转化
            var ol_features = format.read(result);
            abc = ol_features
        }


         // 查询事件的feature↓↓
        function eventQueryByKeyword(keyword, type) {
            return new Promise((resolve, reject) => {
                var queryStruct = new Zondy.Service.QueryFeatureStruct();
                queryStruct.IncludeGeometry = true;

                var queryParam = new Zondy.Service.QueryParameter({
                    resultFormat: "json",
                    struct: queryStruct
                });

                queryParam.pageIndex = 0;
                queryParam.recordNumber = 1000;

                var condition;
                if (type == "common") {
                    condition = "处理状态 != 2 AND (事件类型 LIKE '%" + keyword + "%' OR 发生地点 LIKE '%" + keyword + "%')";
                } else {
                    condition = "发生地点 LIKE '%" + keyword + "%' OR 事件类型 LIKE '%" + keyword + "%'";
                }
                queryParam.where = condition;

                var queryService = new Zondy.Service.QueryDocFeature(queryParam, "guanggu", 2, {});

                queryService.query(result => {
                    var format = new Zondy.Format.PolygonJSON();
                    var ol_features111 = format.read(result);
                    resolve(ol_features111);
                });
            });
        }
    queryByLayer()
       // 查询摄像头的feature↓↓  
    function videoLayer() {
        return new Promise(function(resolve, reject) {
            // 初始化查询结构对象，设置查询结构包含几何信息
            var queryStruct = new Zondy.Service.QueryFeatureStruct();
            queryStruct.IncludeGeometry = true;
            queryStruct.IncludeAttribute = true;
            queryStruct.IncludeWebGraphic = false;
            
            // 指定查询规则
            var rule = new Zondy.Service.QueryFeatureRule({
            EnableDisplayCondition: false,
            MustInside: false,
            CompareRectOnly: false,
            Intersect: true
            });
            
            // 实例化查询参数对象
            var queryParam = new Zondy.Service.QueryParameter({
            resultFormat: "json",
            struct: queryStruct,
            rule: rule
            });
            
            queryParam.pageIndex = 0; // 设置查询分页号
            queryParam.recordNumber = 50; // 设置查询要素数目
            
            var queryService = new Zondy.Service.QueryDocFeature(queryParam, "guanggu", 3, {});
            
            // 执行查询操作
            queryService.query(function(result) {
            var format = new Zondy.Format.PolygonJSON(); // 反序列化
            var ol_features = format.read(result);
            resolve(ol_features); // 将查询结果传递给Promise的resolve函数
            }, function(error) {
            reject(error); // 将错误信息传递给Promise的reject函数
            });
        });
        }
        //事件图层
        function eventAdd() {
        return new Promise(function(resolve, reject) {
            // 初始化查询结构对象，设置查询结构包含几何信息
            var queryStruct = new Zondy.Service.QueryFeatureStruct();
            queryStruct.IncludeGeometry = true;
            queryStruct.IncludeAttribute = true;
            queryStruct.IncludeWebGraphic = false;
            
            // 指定查询规则
            var rule = new Zondy.Service.QueryFeatureRule({
            EnableDisplayCondition: false,
            MustInside: false,
            CompareRectOnly: false,
            Intersect: true
            });
            
            // 实例化查询参数对象
            var queryParam = new Zondy.Service.QueryParameter({
            resultFormat: "json",
            struct: queryStruct,
            rule: rule
            });
            
            queryParam.pageIndex = 0; // 设置查询分页号
            queryParam.recordNumber = 50; // 设置查询要素数目
            
            var queryService = new Zondy.Service.QueryDocFeature(queryParam, "guanggu", 2, {});
            
            // 执行查询操作
            queryService.query(function(result) {
            var format = new Zondy.Format.PolygonJSON(); // 反序列化
            var ol_features = format.read(result);
            resolve(ol_features); // 将查询结果传递给Promise的resolve函数
            }, function(error) {
            reject(error); // 将错误信息传递给Promise的reject函数
            });
        });
        }
        //添加特征点

        function addFeatureCallback(res) {        
         //实例化查询参数对象
         var queryParam = new Zondy.Service.QueryParameter({
             resultFormat: "json",
             struct: queryStruct
         });
         //设置查询分页号
         queryParam.pageIndex = 0;
         //设置查询要素数目
         queryParam.recordNumber = 1;
        //实例化地图文档查询服务对象
        var queryService = new Zondy.Service.QueryDocFeature('guanggu', 2, {
                    ip: 'localhost',
                    port: '6163'
        });
    }
    function getCurentTime() {
        var currentDate = new Date();
        var year = currentDate.getFullYear();
        var month = currentDate.getMonth() + 1;
        var day = currentDate.getDate();

        return year + "-" + month + "-" + day;
        }


        function addFeatureCallback(res) {
            return new Promise(function(resolve, reject) {
                var position = res.feature.getGeometry().getCoordinates();
                var queryStruct = new Zondy.Service.QueryFeatureStruct();
                queryStruct.IncludeGeometry = false;
                queryStruct.IncludeAttribute = false;
                var queryParam = new Zondy.Service.QueryParameter({
                resultFormat: "json",
                struct: queryStruct
                });
                queryParam.pageIndex = 0;
                queryParam.recordNumber = 1;
                var queryService = new Zondy.Service.QueryDocFeature(queryParam, 'guanggu', 2, {
                ip: 'localhost',
                port: '6163'
                });
                queryService.query((result) => {
            var trs = "";    
            var eventType = '<select class="form-control event-type">' +
                '<option value="碰撞">碰撞</option>' +
                '<option value="刮擦">刮擦</option>' +
                '<option value="追尾">追尾</option>' +
                '<option value="碾压">碾压</option>' +
                '<option value="翻车">翻车</option>' +
                '<option value="失火">失火</option>' +
                '<option value="其他">其他</option>' +
                '</select>';
            var eventGrade = '<select class="form-control event-grade">' +
                '<option value="1">轻微事故</option>' +
                '<option value="2">一般事故</option>' +
                '<option value="3">重大事故</option>' +
                '<option value="4">特大事故</option>' +
                '</select>';
            var eventStatus = '<select class="form-control event-status">' +
                '<option value="0">待处理</option>' +
                '<option value="1">处理中</option>' +
                '<option value="2">已归档</option>' +
                '</select>';
            var fldName = result.AttStruct.FldName;
            for (var i = 0, len = fldName.length; i < len; i++) {
                switch (fldName[i]) {
                    case "事件编号":
                        trs += "<tr><td>" + fldName[i] + "</td><td type='" + result.AttStruct.FldType[i]+"'>sj" + getCurentTime(3) + "</td></tr>";
                        break;
                    case "事件类型":
                        trs += "<tr><td>" + fldName[i] + "</td><td type='" + result.AttStruct.FldType[i] +"'>" + eventType + "</td></tr>";
                        break;
                        case "事件等级":
                        trs += "<tr><td>" + fldName[i] + "</td><td type='" + result.AttStruct.FldType[i] +"'>" + eventGrade+"</td></tr>";
                        break;
                    case "发生时间":
                        trs += "<tr><td>" + fldName[i] + "</td><td type='" + result.AttStruct.FldType[i] +"'><input type='datetime-local' placeholder='请输入事件发生时间' value='" + eventAdd.time +"'/></td></tr>";
                        break;
                    case "发生地点":
                        trs += "<tr><td>" + fldName[i] + "</td><td type='" + result.AttStruct.FldType[i] +"'><input type='text' placeholder='武汉市光谷广场' value='"+eventAdd.addr+"'/></td></tr>";
                        break;
                    case "车牌号":
                        trs += "<tr><td>" + fldName[i] + "</td><td type='" + result.AttStruct.FldType[i] +"'><input type='text' placeholder='鄂A00001'/></td></tr>";
                        break;
                    case "驾驶员":
                        trs += "<tr><td>" + fldName[i] + "</td><td type='" + result.AttStruct.FldType[i] +"'><input type='text' placeholder='张天蒋'/></td></tr>";
                        break;
                    case "处理状态":
                        trs += "<tr><td>" + fldName[i] + "</td><td type='" + result.AttStruct.FldType[i] +"'>" + eventStatus+"</td></tr>";
                        break;
                }
            }
            $("#popup-title").html("添加事件");
            $("#popup-content")[0].innerHTML = "<div class='tb-event'><table class='table table-bordered'>" + trs + "</table></div>" +
                "<div class='btn-event'><button class='btn btn-primary btn-sm mr5' onclick='creatFeature(" + position[0] + "," + position[1] + ")'>提交</button><button class='btn btn-default btn-sm ml5' onclick='cancleFeature()'>取消</button></div>";
            $(".event-type option[value='"+eventAdd.type+"']").prop("selected", true);
                resolve(result);
                });
            });
            }
            
            function creatFeature(x, y) {
                //创建一个点形状，描述点形状的几何信息
                var gpoint = new Zondy.Object.GPoint(x, y);
                //设置当前点要素的几何信息
                var fGeom = new Zondy.Object.FeatureGeometry({ PntGeom: [gpoint] });
                //描述点要素的符号参数信息
                var pointInfo = new Zondy.Object.CPointInfo({ Angle: 0, Color: 6, Space: 0, SymHeight: 5, SymID: 21, SymWidth: 5 });
                //设置当前点要素的图形参数信息
                var webGraphicInfo = new Zondy.Object.WebGraphicsInfo({ InfoType: 1, PntInfo: pointInfo });
                //设置添加点要素的属性信息  
                var attValue = [];
                var fldName = [];
                var fldType = [];
                var fldNumber = 0;
                $('#popup table tr').each(function (i, elm) {
                    var value = "";
                    var eventTd0 = $(this).find("td:eq(0)").text();
                    var eventTd1 = $(this).find("td:eq(1)");
                    if (i == 0) {
                        value = eventTd1.text();
                    } else if (eventTd1.find("select").length > 0) {
                        value = eventTd1.find("select").val();
                        if (!isNaN(value)) {
                            value = parseFloat(value);
                        }
                    } else if (eventTd1.find("input").length > 0) {
                        value = eventTd1.find("input").val().trim();
                        if (eventTd1.find("input").prop("type") == "datetime-local") {
                            value = value.replace(/T/g, " ").replace(/-/g, ".");
                        }
                    }
                    var type = eventTd1.attr("type");
                    fldType.push(type);// 遍历 tr
                    attValue.push(value);
                    fldNumber++;
                    fldName.push(eventTd0);
                    console.log(attValue)
                });
                //创建一个要素
                var feature = new Zondy.Object.Feature({ fGeom: fGeom, GraphicInfo: webGraphicInfo, AttValue: attValue });
                //设置要素为点要素
                feature.setFType(1);
                //创建一个要素数据集
                var featureSet = new Zondy.Object.FeatureSet();
                featureSet.clear();
                //设置属性结构
                var cAttStruct = new Zondy.Object.CAttStruct({ FldName: fldName, FldNumber: fldNumber, FldType: fldType });
                featureSet.AttStruct = cAttStruct;
                //添加要素到要素数据集
                featureSet.addFeature(feature);

                //创建一个编辑服务类
                var editService = new Zondy.Service.EditDocFeature('guanggu', 2, { ip: 'localhost', port: '6163' });
                //执行添加点要素功能
                editService.add(featureSet, onPntSuccess);
        }
        function onPntSuccess(){
            console.log('成功')
        }

        function eventQueryVecLayerCallback(feature) {
            return new Promise(function(resolve, reject) {
                //初始化查询结构对象，设置查询结构包含几何信息
        var queryStruct = new Zondy.Service.QueryFeatureStruct();
        //是否包含几何图形信息
        queryStruct.IncludeGeometry = true;
        //是否包含属性信息
        queryStruct.IncludeAttribute = true;
        //是否包含图形显示参数
        queryStruct.IncludeWebGraphic = false;
        //创建一个用于查询的点
        var geomObj = new Zondy.Object.Circle();
        // 将openlayers的点几何转换为MapGIS的点几何
        geomObj.setByOL(feature.feature.values_.geometry);
        //指定查询规则
        var rule = new Zondy.Service.QueryFeatureRule({
            //是否将要素的可见性计算在内
            EnableDisplayCondition: false,
            //是否完全包含
            MustInside: false,
            //是否仅比较要素的外包矩形
            CompareRectOnly: false,
            //是否相交
            Intersect: true
        });
        //实例化查询参数对象
        var queryParam = new Zondy.Service.QueryParameter({
            geometry: geomObj,
            resultFormat: "json",
            struct: queryStruct,
            rule: rule
        });
        //设置查询分页号
        queryParam.pageIndex = 0;
        //设置查询要素数目
        queryParam.recordNumber = 1000;
        //实例化地图文档查询服务对象
        var queryService = new Zondy.Service.QueryDocFeature(queryParam, 'guanggu', 2, {
            ip: 'localhost',
            port: '6163'
        });
        //执行查询操作，querySuccess为查询回调函数
        queryService.query(function(result) {
            resolve(result); // 将查询结果传递给Promise的resolve函数
            })
            })
        
    }

    function createHeatMapByEvent(result) {
    // stopPressBar();
        var format = new Zondy.Format.PolygonJSON();
        var features = format.read(result);
        return  features
    }

    function constructAnnouncementCallback(result) {
        return new Promise(function(resolve, reject) {
       var pointObj = new Array();
        for (var i = 0; i < result.feature.getGeometry().getCoordinates().length; i++) {
            var pointGeo = new Zondy.Object.Point2D(result.feature.getGeometry().getCoordinates()[i][0], result.feature.getGeometry().getCoordinates()[i][1]);
            pointObj.push(pointGeo);
        }
        console.log(pointObj)
        var gArc = new Zondy.Object.Arc(pointObj);
        //构成线的折线
        var gAnyLine = new Zondy.Object.AnyLine([gArc]);
        //设置线要素的几何信息
        var gline = new Zondy.Object.GLine(gAnyLine);
        //设置要素的几何信息
        var fGeom = new Zondy.Object.FeatureGeometry({ LinGeom: [gline] });
        //设置属性结构

        var regAttStr = new Zondy.Object.CAttStruct({
            FldName: ["ID", "面积", "周长", "LayerID"],
            FldNumber: 4,
            FldType: ["FldLong", "FldDouble", "FldDouble", "FldLong"]
        });
        var values = [0, 62.566714, 50.803211, 0];
        var valuesRow = new Zondy.Object.CAttDataRow(values, 1);
        var featureBufBySR = new Zondy.Service.FeatureBuffBySingleRing({
            ip: 'localhost',
            port: '6163',
            //设置要素缓冲分析左半径
            leftRad: 0.002,
            //设置要素缓冲分析右半径
            rightRad: 0.002
        });
        featureBufBySR.sfGeometryXML = JSON.stringify([fGeom]);
        //设置属性结构
        featureBufBySR.attStrctXML = JSON.stringify(regAttStr);
        //设置属性值
        featureBufBySR.attRowsXML = JSON.stringify([valuesRow]);
        //设置追踪半径
        featureBufBySR.traceRadius = 0.0001;
        //设置缓冲结果的名称以及存放地址
        featureBufBySR.resultName = "gdbp://MapGisLocal/wuhan/ds/buffer/sfcls/bufferresult" + getCurentTime();
        //调用Zondy.Service.AnalysisBase基类的execute方法执行要素缓冲分析，AnalysisSuccess为回调函数。
        featureBufBySR.execute(
            bufferSuccess
        , "post", false, "json");
    })
    
}




    function bufferSuccess(result) {
        var clspath = result.results[0].Value;
        //实例化ClipByLayer类
        var clipParam = new Zondy.Service.ClipByLayer({
            ip: 'localhost',
            port: '6163',
            //源简单要素类的URL
            srcInfo1: "gdbp://MapGisLocal/wuhan/sfcls/居民区",
            //裁剪框简单要素类的URL
            srcInfo2: clspath,
            //设置结果URL
            desInfo: "gdbp://MapGisLocal/wuhan/ds/clip/sfcls/clipresult" + getCurentTime(),
            infoOptType: 0
        });
        //调用基类的execute方法，执行图层裁剪分析。AnalysisSuccess为结果回调函数
        clipParam.execute(clipSuccess, "post", false, "json", clipError);
    }

    function clipSuccess(e){
        console.log(e)
    }

    function clipError(){
        console.log('错误')
    }

    
    
    </script>

  </body>
</html>





